name: 'Build Owlcat Mod'
description: 'Builds an Owlcat Mod project and outputs relevant build information.'
author: 'xADDBx'

inputs:
  GAME_NAME:
    description: 'Name of the game which the mod targets'
    required: true
    type: choice
    default: Wrath
    options:
      - Kingmaker
      - Wrath
      - RogueTrader
  GITHUB_TOKEN:
    description: 'GitHub token for accessing the package registry.'
    required: true
    default: '${{ secrets.GITHUB_TOKEN }}'
  GITHUB_NAME:
    description: 'Account used to connect to package registry.'
    required: false
    default: '${{ github.repository_owner }}'
  PACKAGE_OWNER:
    description: 'Account which owns package.'
    required: false
    default: 'xADDBx'
  

outputs:
  zipFile:
    description: 'Name of the zip file generated by the build.'
  zipFilePath:
    description: 'Path to the directory containing the zip file.'
  gameVersionNum:
    description: 'Number of the game version.'
  gameVersionSuffix:
    description: 'Suffix of the game version.'
  outDir:
    description: 'Output directory for the build.'

runs:
  using: 'composite'
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2

    - name: Add NuGet Source
      run: nuget sources add -name github -source https://nuget.pkg.github.com/${{ inputs.PACKAGE_OWNER }}/index.json -username ${{ inputs.GITHUB_NAME }} -password ${{ inputs.GITHUB_TOKEN }} -StorePasswordInClearText -Verbosity detailed

    - name: Install NuGet package
      run: nuget install ${{ inputs.GAME_NAME }}GameAssemblies -Source github -OutputDirectory GameFiles -DependencyVersion Highest -DirectDownload -PreRelease -Verbosity detailed

    - name: Restore
      run: dotnet restore

    - name: Find subdirectory
      id: find-dir
      shell: pwsh
      run: |
        $currentPath = "${{ github.workspace }}"
        $prefixPath = Join-Path -Path $currentPath -ChildPath 'GameFiles'
        $subdirectory = Get-ChildItem -Path $prefixPath -Directory | Select-Object -First 1 -ExpandProperty Name
        $versionSuffix = [regex]::Match($subdirectory, '(?<=\d+\.\d+\.\d+-).+$').Value
        $versionNumber = [regex]::Match($subdirectory, '\d+\.\d+\.\d+').Value
        $fullPath = Join-Path -Path $prefixPath -ChildPath $subdirectory
        $currentDirName = Split-Path -Path $currentPath -Leaf
        echo "currentDirName=$currentDirName" >> $env:GITHUB_ENV
        echo "fullPath=$fullPath" >> $env:GITHUB_ENV
        echo "gameVersionSuffix=$versionSuffix" >> $env:GITHUB_ENV
        echo "gameVersionNum=$versionNumber" >> $env:GITHUB_ENV
        echo "::set-output name=gameVersionNum::$versionNumber"
        echo "::set-output name=gameVersionSuffix::$versionSuffix"

    - name: Build Project
      run: msbuild /p:Configuration=Release /p:${{ inputs.GAME_NAME }}Data="${{ env.fullPath }}\UserDataDir" /p:${{ inputs.GAME_NAME }}InstallDir="${{ env.fullPath }}\Assemblies" /p:OutputPath=Out\Bin

    - name: Find zip file
      id: find-zip
      shell: pwsh
      run: |
        $prefixPath = "${{ github.workspace }}"
        $zipFileObject = Get-ChildItem -Recurse -Path $prefixPath -Filter "*.zip" | Where-Object { $_.Directory.Name -eq 'Out' } | Select-Object -First 1
        $zipFile = $zipFileObject.BaseName
        $zipFilePath = (Get-Item $zipFileObject.FullName).Directory.FullName
        echo "zipFile=$zipFile" >> $env:GITHUB_ENV
        echo "zipFilePath=$zipFilePath" >> $env:GITHUB_ENV
        echo "::set-output name=zipFile::$zipFile"
        echo "::set-output name=zipFilePath::$zipFilePath"
        $outDir = Join-Path -Path $zipFilePath -ChildPath 'Bin'
        echo "::set-output name=outDir::$outDir"
